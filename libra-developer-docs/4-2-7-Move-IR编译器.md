# Move IR编译器

原文链接：[https://developers.libra.org/docs/crates/ir-to-bytecode](https://developers.libra.org/docs/crates/ir-to-bytecode)<br/>
译者：humyna<br/>
日期：2019.09.25<br/>
版权及转载声明：本文采用[知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议](https://creativecommons.org/licenses/by-nc-nd/4.0/)进行许可。<br/>

Move IR编译器将Move IR编译为其字节码表示形式。

## 概述

Move IR编译器把Move语言编写模块和脚本编译为对应以字节码表示形式，`CompiledModule` 和 `CompiledScript` 这两种数据类型用于表示这些输出。这些数据类型定义在 [file_format.rs](https://github.com/libra/libra/blob/master/language/vm/src/file_format.rs) 中有定义。

除了把Move IR转换为Move字节码之外，编译器也可以作为字节码验证器的一个测试工具。 因此，它的工作是输出尽可能接近输入IR的字节码程序; 在编译过程中不会执行优化和高级语义检查。事实上，编译器将这些语义检查放到字节码中进行，并在Move IR中将语义无效的代码编译成等价的语义无效的字节码程序。然后通过 [bytecode verifier](https://github.com/libra/libra/blob/master/language/bytecode_verifier/README.md) 验证编译后的字节码的语义。 编译器命令行在编译最后自动调用字节码验证器。

## 命令行选项

```
USAGE:
    compiler [FLAGS] [OPTIONS] 

FLAGS:
    -h, --help         Prints help information
        --no-stdlib    Do not automatically compile stdlib dependencies
        --no-verify    Do not automatically run the bytecode verifier
    -s, --script       Treat input file as a script (default is to treat file as a module)
    -V, --version      Prints version information

OPTIONS:
    -o, --output     Serialize and write the compiled output to this file

ARGS:
        Path to the Move IR source to compile
```

### 示例用法

> cargo build -—bin compiler


- 这将生成 编译器+验证器 二进制文件。
- 二进制文件可以在 `libra/target/debug/compiler` 找到.
- 此外，二进制文件也可以直接使用 `cargo run -p compiler` 运行.


编译并验证 `foo.mvir` Move IR 模块文件:

> `compiler foo.mvir`


编译并验证 `bar.mvir` 交易脚本文件:

> `compiler -s bar.mvir`


## 代码结构

```
compiler                        # Main compiler crate. This depends on stdlib.
├── ir_to_bytecode              # Core backend compiler logic, independent of stdlib.
│   ├── src
│   │   ├── compiler.rs         # Main compiler logic - converts an AST generated by `syntax.rs` to a `CompiledModule` or `CompiledScript`.
│   │   └── parser.rs           # Wrapper around Move IR syntax crate.
│   └── syntax                  # Crate containing Move IR syntax.
│       └── src
│           ├── ast.rs          # Contains all the data structures used to build the AST representing the parsed Move IR input.
│           ├── syntax.lalrpop  # Description of the Move IR language, used by lalrpop to generate a parser.
            └── syntax.rs       # Parser generated by lalrpop using the description in `syntax.lalrpop` - a clean checkout won't contain this file.
└── src
    ├── main.rs                 # Compiler driver - parses command line options and calls the parser, compiler, and bytecode verifier.
    └── util.rs                 # Misc compiler utilities.
```

